/**
 * Marketing Tools Suite - Main Application
 * Professional modular JavaScript architecture
 */

class MarketingToolsApp {
    constructor() {
        this.currentTool = 'home';
        this.toolsLoaded = new Set();
        this.toolInstances = new Map();
        this.isLoading = false;

        this.init();
    }

    /**
     * Initialize the application
     */
    init() {
        this.setupEventListeners();
        this.setupNavigation();
        this.setupHashRouting();

        // Handle initial route from hash
        this.handleHashChange();

        // Ensure loading overlay is hidden on init
        this.hideLoading();
    }

    /**
     * Setup hash-based routing
     */
    setupHashRouting() {
        // Listen for hash changes
        window.addEventListener('hashchange', () => {
            this.handleHashChange();
        });
    }

    /**
     * Handle hash change events
     */
    async handleHashChange() {
        const hash = window.location.hash.substring(1); // Remove the '#'

        if (!hash || hash === '') {
            this.showHome(false);
        } else if (hash === 'business-card' || hash === 'discount-offer' || hash === 'social-media') {
            await this.showTool(hash, false);
        } else {
            // Unknown hash, go to home
            this.showHome(false);
        }
    }

    /**
     * Setup global event listeners
     */
    setupEventListeners() {
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        mobileMenuBtn?.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!mobileMenuBtn?.contains(e.target) && !mobileMenu?.contains(e.target)) {
                mobileMenu?.classList.add('hidden');
            }
        });

        // Handle browser navigation
        // Note: Using hash-based routing instead of popstate
        // The hashchange event is handled in setupHashRouting()

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'h':
                        e.preventDefault();
                        this.showHome();
                        break;
                    case '1':
                        e.preventDefault();
                        this.showTool('business-card');
                        break;
                    case '2':
                        e.preventDefault();
                        this.showTool('discount-offer');
                        break;
                    case '3':
                        e.preventDefault();
                        this.showTool('social-media');
                        break;
                }
            }
        });
    }

    /**
     * Setup navigation styles
     */
    setupNavigation() {
        const style = document.createElement('style');
        style.textContent = `
            .nav-link {
                @apply flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-primary-600 hover:bg-primary-50 transition-colors duration-200;
            }
            
            .nav-link.active {
                @apply text-primary-600 bg-primary-50;
            }
            
            .mobile-nav-link {
                @apply px-4 py-2 text-gray-600 hover:text-primary-600 hover:bg-primary-50 rounded-md transition-colors duration-200;
            }
        `;
        document.head.appendChild(style);
    }

    /**
     * Show home section
     */
    showHome(updateHistory = true) {
        if (this.currentTool === 'home') return;
        
        this.currentTool = 'home';
        
        // Hide all tool sections
        document.querySelectorAll('.tool-section').forEach(section => {
            section.classList.add('hidden');
        });
        
        // Show home section
        const homeSection = document.getElementById('home-section');
        const footer = document.getElementById('main-footer');
        
        if (homeSection) homeSection.classList.remove('hidden');
        if (footer) footer.style.display = 'block';
        
        // Update navigation
        this.updateNavigation('home');
        
        // Update URL and title (using hash-based routing)
        if (updateHistory) {
            window.location.hash = '';
        }
        document.title = 'Marketing Tools Suite | Create Professional Marketing Materials';
        
        // Close mobile menu
        document.getElementById('mobile-menu')?.classList.add('hidden');
    }

    /**
     * Show specific tool
     */
    async showTool(toolName, updateHistory = true) {
        console.log(`showTool called with: ${toolName}, updateHistory: ${updateHistory}`);
        
        if (this.currentTool === toolName) {
            console.log('Tool already active, skipping');
            return;
        }
        
        if (this.isLoading) {
            console.log('Already loading, skipping');
            return;
        }
        
        this.currentTool = toolName;
        this.showLoading();
        
        try {
            console.log('Starting tool switch...');
            
            // Hide home and footer
            const homeSection = document.getElementById('home-section');
            const footer = document.getElementById('main-footer');
            
            if (homeSection) {
                homeSection.classList.add('hidden');
                console.log('Home section hidden');
            }
            if (footer) {
                footer.style.display = 'none';
                console.log('Footer hidden');
            }
            
            // Hide all tool sections
            document.querySelectorAll('.tool-section').forEach(section => {
                section.classList.add('hidden');
            });
            console.log('All tool sections hidden');
            
            // Clean up old tool scripts to prevent conflicts
            this.cleanupOldToolScripts(toolName);
            
            // Show target tool section
            const toolSection = document.getElementById(`${toolName}-section`);
            if (toolSection) {
                toolSection.classList.remove('hidden');
                console.log(`Tool section ${toolName} shown`);
            } else {
                console.error(`Tool section not found: ${toolName}-section`);
            }
            
            // Load tool if not already loaded
            if (!this.toolsLoaded.has(toolName)) {
                console.log(`Tool ${toolName} not loaded yet, loading...`);

                // Add timeout to prevent infinite loading
                const loadPromise = this.loadTool(toolName);
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Tool loading timeout')), 10000); // 10 second timeout
                });

                await Promise.race([loadPromise, timeoutPromise]);
            } else {
                console.log(`Tool ${toolName} already loaded, refreshing...`);

                // Tool already loaded, but refresh it
                if (toolName === 'business-card' && window.initBusinessCardToolIfNeeded) {
                    setTimeout(() => {
                        window.initBusinessCardToolIfNeeded();
                    }, 100);
                }
            }
            
            // Update navigation
            this.updateNavigation(toolName);
            
            // Update URL and title (using hash-based routing for refresh compatibility)
            if (updateHistory) {
                const titles = {
                    'business-card': 'Business Card Designer | Marketing Tools Suite',
                    'discount-offer': 'Discount Offer Creator | Marketing Tools Suite',
                    'social-media': 'Social Media Designer | Marketing Tools Suite'
                };

                window.location.hash = toolName;
                document.title = titles[toolName];
                console.log('Hash and title updated to:', window.location.hash);
            }
            
            // Close mobile menu
            document.getElementById('mobile-menu')?.classList.add('hidden');
            
            console.log(`Tool ${toolName} loaded and shown successfully`);
            
        } catch (error) {
            console.error('Error in showTool:', error);
            this.showNotification(window.i18n?.t('notification.tool_error') || 'Failed to load tool. Please try again.', 'error');
            
            // Fallback to home on error
            setTimeout(() => {
                this.showHome();
            }, 2000);
            
        } finally {
            console.log('Hiding loading spinner');
            this.hideLoading();
        }
    }

    /**
     * Get inline tool content for GitHub Pages deployment
     */
    getInlineToolContent(toolName) {
        const toolContent = {
            'social-media': this.getSocialMediaToolContent(),
            'business-card': this.getBusinessCardToolContent(),
            'discount-offer': this.getDiscountOfferToolContent()
        };
        
        return toolContent[toolName] || null;
    }

    /**
     * Enhanced Social Media Tool Content
     */
    getSocialMediaToolContent() {
        return `<!-- Professional Libraries -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/bidi-js@1.0.3/dist/bidi.min.js"></script>
<script src="https://unpkg.com/opentype.js@1.3.4/dist/opentype.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Inter:wght@300;400;600;700&family=Cairo:wght@200;300;400;600;700;900&family=Rubik:wght@300;400;500;600;700;800&family=Tajawal:wght@200;300;400;500;700;800&family=Amiri:wght@400;700&family=Lato:wght@300;400;700;900&family=Open+Sans:wght@300;400;600;700;800&family=Roboto:wght@300;400;500;700;900&family=Poppins:wght@300;400;500;600;700;800&family=Montserrat:wght@300;400;500;600;700;800&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Tool Script -->
<script src="js/social-media-tool.js"></script>

<style>
    .social-media-tool {
        font-family: 'Almarai', sans-serif;
        direction: rtl;
        padding: 20px;
    }

    .social-media-tool * {
        box-sizing: border-box;
    }

    .social-media-tool .main-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .social-media-tool .platforms-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .social-media-tool .platform-btn {
        padding: 15px;
        border: 3px solid #667eea;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 700;
        transition: all 0.3s;
        text-align: center;
    }

    .social-media-tool .platform-btn:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }

    .social-media-tool .platform-btn.active {
        background: #667eea;
        color: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .social-media-tool .content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .social-media-tool .editor-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-height: 80vh;
        overflow-y: auto;
    }

    .social-media-tool .panel-title {
        font-size: 20px;
        font-weight: 900;
        color: #667eea;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .social-media-tool .section-group {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .social-media-tool .section-title {
        font-size: 13px;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .social-media-tool .form-group {
        margin-bottom: 15px;
    }

    .social-media-tool .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
        font-size: 12px;
    }

    .social-media-tool .form-group input,
    .social-media-tool .form-group select,
    .social-media-tool .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 12px;
        transition: border-color 0.3s;
        font-family: 'Almarai', sans-serif;
    }

    .social-media-tool .form-group input:focus,
    .social-media-tool .form-group select:focus,
    .social-media-tool .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }

    .social-media-tool .color-input {
        width: 50px !important;
        height: 40px;
        padding: 0;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .social-media-tool .btn {
        padding: 10px 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: background 0.3s;
        font-family: 'Almarai', sans-serif;
    }

    .social-media-tool .btn:hover {
        background: #5a6fd8;
    }

    .social-media-tool .btn-success {
        background: #28a745;
    }

    .social-media-tool .btn-success:hover {
        background: #218838;
    }

    .social-media-tool .btn-danger {
        background: #dc3545;
    }

    .social-media-tool .btn-danger:hover {
        background: #c82333;
    }

    .social-media-tool .btn-warning {
        background: #ffc107;
        color: #000;
    }

    .social-media-tool .btn-warning:hover {
        background: #e0a800;
    }

    .social-media-tool .buttons-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 15px;
    }

    .social-media-tool .viewer-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
    }

    .social-media-tool .platform-info {
        margin-bottom: 20px;
        padding: 15px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-radius: 10px;
        text-align: center;
    }

    .social-media-tool .platform-name {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .social-media-tool .platform-dimensions {
        font-size: 12px;
        opacity: 0.9;
    }

    .social-media-tool #konvaContainer {
        margin: 20px auto;
        border: 3px solid #667eea;
        border-radius: 15px;
        background: #f9f9f9;
        padding: 20px;
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .social-media-tool .export-section {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
    }

    .social-media-tool .selection-info {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 12px;
        border-left: 4px solid #667eea;
    }

    .social-media-tool #textFormattingPanel {
        background: #e8f2ff;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: none;
    }

    .social-media-tool #textFormattingPanel h4 {
        color: #667eea;
        font-size: 14px;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .social-media-tool .text-formatting-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 10px;
    }

    .social-media-tool .text-formatting-buttons .btn {
        padding: 8px;
        font-size: 11px;
    }

    .social-media-tool .font-controls {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }

    .social-media-tool .background-toggle {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .social-media-tool .background-toggle button {
        padding: 8px;
        font-size: 11px;
    }

    .social-media-tool .background-toggle button.active {
        background: #667eea;
        color: white;
    }

    .social-media-tool .image-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .social-media-tool .image-controls input {
        padding: 5px;
        font-size: 11px;
    }

    @media (max-width: 768px) {
        .social-media-tool .content {
            grid-template-columns: 1fr;
        }
        
        .social-media-tool .platforms-selector {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
        
        .social-media-tool .export-section {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="social-media-tool">
    <div class="main-container">
        <!-- Platform Selection -->
        <div class="platforms-selector">
            <button class="platform-btn active" onclick="selectPlatform('instagram')">
                <i class="fab fa-instagram"></i><br>Instagram<br>1080Ã—1350
            </button>
            <button class="platform-btn" onclick="selectPlatform('instastory')">
                <i class="fab fa-instagram"></i><br>Story<br>1080Ã—1920
            </button>
            <button class="platform-btn" onclick="selectPlatform('facebook')">
                <i class="fab fa-facebook"></i><br>Facebook<br>1200Ã—1500
            </button>
            <button class="platform-btn" onclick="selectPlatform('twitter')">
                <i class="fab fa-twitter"></i><br>Twitter<br>1024Ã—512
            </button>
        </div>

        <div class="content">
            <!-- Editor Panel -->
            <div class="editor-panel">
                <h2 class="panel-title">
                    <i class="fas fa-edit"></i>
                    Ù…Ø­Ø±Ø± Ø§Ù„ØªØµÙ…ÙŠÙ…
                </h2>

                <!-- Store Information -->
                <div class="section-group">
                    <div class="section-title">
                        <i class="fas fa-store"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label>
                        <input type="text" id="storeName" value="Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ø´Ø§Ø±Ù‚Ø©" onchange="updateCanvas()">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø´Ø¹Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="tagline" placeholder="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±" onchange="updateCanvas()">
                    </div>
                </div>

                <!-- Main Content -->
                <div class="section-group">
                    <div class="section-title">
                        <i class="fas fa-bullhorn"></i> Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                        <input type="text" id="mainTitle" value="Ø®ØµÙˆÙ…Ø§Øª Ù‡Ø§Ø¦Ù„Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…" onchange="updateCanvas()">
                    </div>
                    <div class="form-group">
                        <label>Ù†Øµ Ø§Ù„Ø´Ø§Ø±Ø©</label>
                        <input type="text" id="badgeText" value="Ø®ØµÙ… 50%" onchange="updateCanvas()">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ</label>
                        <input type="text" id="subtitle" value="Ø§Ø¶ØºØ· Ø§Ù„Ø¢Ù† Ù„Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶" onchange="updateCanvas()">
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="section-group">
                    <div class="section-title">
                        <i class="fas fa-phone"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="tel" id="phoneNumber" placeholder="+971 50 123 4567" onchange="updateCanvas()">
                    </div>
                    <div class="form-group">
                        <label>Ø­Ø³Ø§Ø¨ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„</label>
                        <input type="text" id="socialHandle" value="@alalamy.sharjah" placeholder="@username" onchange="updateCanvas()">
                    </div>
                </div>

                <!-- Categories -->
                <div class="section-group">
                    <div class="section-title">
                        <i class="fas fa-tags"></i> Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª
                    </div>
                    <div id="categoriesContainer">
                        <div class="category-item">
                            <div class="form-group">
                                <label>Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label>
                                <input type="text" class="category-name" value="Ø£Ø­Ø°ÙŠØ©" onchange="updateCanvas()">
                            </div>
                            <div class="form-group">
                                <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label>
                                <input type="number" class="category-discount" value="30" min="0" max="100" onchange="updateCanvas()">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn" onclick="addCategory()">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>

                <!-- Design Tools -->
                <div class="section-group">
                    <div class="section-title">
                        <i class="fas fa-tools"></i> Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…
                    </div>
                    
                    <!-- Selection Info -->
                    <div class="selection-info" id="selectionInfo">
                        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù†ØµØ± Ù„ØªØ­Ø¯ÙŠØ¯Ù‡ ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡
                    </div>

                    <!-- Text Formatting Panel -->
                    <div id="textFormattingPanel">
                        <h4><i class="fas fa-font"></i> ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ</h4>
                        <div class="text-formatting-buttons">
                            <button type="button" class="btn" onclick="makeTextBold()">
                                <i class="fas fa-bold"></i> Ø¹Ø±ÙŠØ¶
                            </button>
                            <button type="button" class="btn" onclick="makeTextItalic()">
                                <i class="fas fa-italic"></i> Ù…Ø§Ø¦Ù„
                            </button>
                            <button type="button" class="btn" onclick="toggleTextDirection()">
                                <i class="fas fa-exchange-alt"></i> Ø§ØªØ¬Ø§Ù‡
                            </button>
                            <button type="button" class="btn" onclick="alignTextLeft()">
                                <i class="fas fa-align-left"></i> ÙŠØ³Ø§Ø±
                            </button>
                            <button type="button" class="btn" onclick="alignTextCenter()">
                                <i class="fas fa-align-center"></i> ÙˆØ³Ø·
                            </button>
                            <button type="button" class="btn" onclick="alignTextRight()">
                                <i class="fas fa-align-right"></i> ÙŠÙ…ÙŠÙ†
                            </button>
                        </div>
                        <div class="font-controls">
                            <select id="fontSelect" onchange="changeFontFamily()">
                                <option value="Almarai">Almarai (Ø¹Ø±Ø¨ÙŠ)</option>
                                <option value="Cairo">Cairo (Ø¹Ø±Ø¨ÙŠ)</option>
                                <option value="Tajawal">Tajawal (Ø¹Ø±Ø¨ÙŠ)</option>
                                <option value="Amiri">Amiri (Ø¹Ø±Ø¨ÙŠ)</option>
                                <option value="Inter">Inter (English)</option>
                                <option value="Roboto">Roboto (English)</option>
                                <option value="Poppins">Poppins (English)</option>
                            </select>
                            <input type="number" id="fontSizeInput" value="24" min="8" max="200" onchange="changeFontSize()" placeholder="Ø­Ø¬Ù…">
                        </div>
                    </div>

                    <!-- Design Action Buttons -->
                    <div class="buttons-grid">
                        <button type="button" class="btn" onclick="duplicateSelected()">
                            <i class="fas fa-copy"></i> Ù†Ø³Ø®
                        </button>
                        <button type="button" class="btn btn-danger" onclick="deleteSelected()">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                        <button type="button" class="btn" onclick="bringToFront()">
                            <i class="fas fa-arrow-up"></i> Ù„Ù„Ø£Ù…Ø§Ù…
                        </button>
                        <button type="button" class="btn" onclick="sendToBack()">
                            <i class="fas fa-arrow-down"></i> Ù„Ù„Ø®Ù„Ù
                        </button>
                        <button type="button" class="btn btn-warning" onclick="clearAll()">
                            <i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
                        </button>
                        <button type="button" class="btn" onclick="resetPositions()">
                            <i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨
                        </button>
                    </div>
                </div>

                <!-- Colors -->
                <div class="section-group">
                    <div class="section-title">
                        <i class="fas fa-palette"></i> Ø§Ù„Ø£Ù„ÙˆØ§Ù†
                    </div>
                    <div class="form-group">
                        <label>Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                        <input type="color" id="textColor" class="color-input" value="#ffffff" onchange="updateCanvas()">
                    </div>
                    <div class="form-group">
                        <label>Ù„ÙˆÙ† Ø§Ù„Ø´Ø§Ø±Ø©</label>
                        <input type="color" id="accentColor" class="color-input" value="#ff6b6b" onchange="updateCanvas()">
                    </div>
                </div>

                <!-- Background -->
                <div class="section-group">
                    <div class="section-title">
                        <i class="fas fa-image"></i> Ø§Ù„Ø®Ù„ÙÙŠØ©
                    </div>
                    
                    <div class="background-toggle">
                        <button type="button" class="btn active" onclick="selectBackgroundType('gradient')">ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ</button>
                        <button type="button" class="btn" onclick="selectBackgroundType('image')">ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ©</button>
                    </div>
                    
                    <div id="gradientControls">
                        <div class="form-group">
                            <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„</label>
                            <input type="color" id="bgColor1" class="color-input" value="#667eea" onchange="updateCanvas()">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
                            <input type="color" id="bgColor2" class="color-input" value="#764ba2" onchange="updateCanvas()">
                        </div>
                    </div>
                    
                    <div id="imageControls" style="display: none;">
                        <div class="form-group">
                            <label>Ø±ÙØ¹ ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ©</label>
                            <input type="file" id="backgroundImageUpload" accept="image/*" onchange="handleBackgroundImageUpload(event)">
                        </div>
                        <div class="image-controls">
                            <input type="range" id="bgImageX" min="-50" max="50" value="0" onchange="updateBackgroundImage()" title="Ù…ÙˆØ¶Ø¹ Ø£ÙÙ‚ÙŠ">
                            <input type="range" id="bgImageY" min="-50" max="50" value="0" onchange="updateBackgroundImage()" title="Ù…ÙˆØ¶Ø¹ Ø±Ø£Ø³ÙŠ">
                            <input type="range" id="bgImageScale" min="50" max="200" value="100" onchange="updateBackgroundImage()" title="Ø§Ù„Ø­Ø¬Ù…">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Viewer Panel -->
            <div class="viewer-panel">
                <div class="platform-info">
                    <div class="platform-name" id="platformName">Instagram Square</div>
                    <div class="platform-dimensions" id="platformDimensions">1080 Ã— 1080 pixels</div>
                </div>

                <div id="konvaContainer"></div>
                
                <div style="margin-top: 10px; text-align: center;">
                    <button onclick="window.debugKonva()" style="padding: 10px; background: #ff6b6b; color: white; border: none; border-radius: 5px;">
                        ğŸ”§ Debug Canvas
                    </button>
                    <button onclick="window.initializeSocialMediaToolManually()" style="padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; margin-left: 10px;">
                        ğŸš€ Initialize Canvas
                    </button>
                </div>

                <div class="export-section">
                    <button type="button" class="btn btn-success" onclick="exportDesign('png', 2)">
                        <i class="fas fa-download"></i><br>ØªØµØ¯ÙŠØ± Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportDesign('png', 1)">
                        <i class="fas fa-download"></i><br>ØªØµØ¯ÙŠØ± Ø¬ÙˆØ¯Ø© Ø¹Ø§Ø¯ÙŠØ©
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportDesign('jpg', 3)">
                        <i class="fas fa-download"></i><br>ØªØµØ¯ÙŠØ± Ø¬ÙˆØ¯Ø© ÙØ§Ø¦Ù‚Ø©
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

</script>`;
    }

    /**
     * Enhanced Bilingual Business Card Tool Content
     */
    getBusinessCardToolContent() {
        return `<!-- Professional Libraries -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/bidi-js@1.0.3/dist/bidi.min.js"></script>

<!-- Tool Script -->
<script src="js/business-card-tool-new.js"></script>
<script>
// Initialize business card tool after script loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (window.initBusinessCardToolIfNeeded) {
            window.initBusinessCardToolIfNeeded();
        }
    }, 1000);
});
</script>

<!-- Bilingual Business Card Tool -->
<div class="min-h-screen bg-gray-50 font-almarai">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tool Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center space-x-3 mb-4">
                <div class="w-12 h-12 bg-indigo-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-id-card text-white text-xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900" data-i18n="business_card.title">Business Card Designer</h1>
            </div>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto" data-i18n="business_card.subtitle">Create professional business cards with bilingual support</p>
        </div>

        <!-- Tab Navigation -->
        <div class="flex justify-center mb-8">
            <nav class="flex space-x-1 bg-gray-100 rounded-lg p-1">
                <button id="tab-english" onclick="switchBusinessCardTab('english')" class="business-card-tab px-6 py-2 text-sm font-medium rounded-md transition-colors bg-white text-indigo-600 shadow-sm">
                    <span data-i18n="business_card.tabs.english">English Side</span>
                </button>
                <button id="tab-arabic" onclick="switchBusinessCardTab('arabic')" class="business-card-tab px-6 py-2 text-sm font-medium rounded-md transition-colors text-gray-500 hover:text-gray-700">
                    <span data-i18n="business_card.tabs.arabic">Arabic Side</span>
                </button>
                <button id="tab-design" onclick="switchBusinessCardTab('design')" class="business-card-tab px-6 py-2 text-sm font-medium rounded-md transition-colors text-gray-500 hover:text-gray-700">
                    <span data-i18n="business_card.tabs.design">Design</span>
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Form Panel -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <!-- English Tab Content -->
                <div id="english-content" class="tab-content">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="business_card.english.shop_details">ğŸ‘” English Shop Details</h3>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.english.shop_name">Shop Name (English)</label>
                                <input type="text" id="shop-name-en" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.english.shop_name_placeholder" value="AL-ALAMIA">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.english.tagline">Tagline/Location</label>
                                <input type="text" id="tagline-en" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.english.tagline_placeholder" value="Sharjah, UAE">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.english.phone">Phone Number</label>
                                    <input type="tel" id="phone-en" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.english.phone_placeholder" value="+971 XX XXX XXXX">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.english.email">Email</label>
                                    <input type="email" id="email-en" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.english.email_placeholder" value="info@alamia.ae">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.english.website">Website</label>
                                <input type="url" id="website-en" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.english.website_placeholder" value="www.alamia-sharjah.ae">
                            </div>
                        </div>
                    </div>

                    <!-- Services Section -->
                    <div class="mb-6">
                        <h4 class="text-md font-semibold text-gray-900 mb-3" data-i18n="business_card.english.services_title">ğŸ“± Services</h4>
                        <div id="services-en-list" class="space-y-2 mb-3">
                            <!-- Services will be dynamically added here -->
                        </div>
                        <div class="flex">
                            <input type="text" id="new-service-en" class="flex-1 px-3 py-2 border border-gray-300 rounded-s-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.english.new_service_placeholder">
                            <button onclick="addServiceEn()" class="px-4 py-2 bg-indigo-600 text-white rounded-e-md hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500" data-i18n="business_card.english.add_service">+ Add Service</button>
                        </div>
                    </div>
                </div>

                <!-- Arabic Tab Content -->
                <div id="arabic-content" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="business_card.arabic.shop_details">ğŸ‘” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h3>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.arabic.shop_name">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± (Ø¹Ø±Ø¨ÙŠ)</label>
                                <input type="text" id="shop-name-ar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.arabic.shop_name_placeholder" value="Ø§Ù„Ø¹Ø§Ù„Ù…Ù‰ Ø§Ù„Ø´Ø§Ø±Ù‚Ø©">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.arabic.tagline">Ø§Ù„Ø´Ø¹Ø§Ø±/Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                                <input type="text" id="tagline-ar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.arabic.tagline_placeholder" value="Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.arabic.phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                    <input type="tel" id="phone-ar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.arabic.phone_placeholder" value="+971 XX XXX XXXX">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.arabic.email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                    <input type="email" id="email-ar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.arabic.email_placeholder" value="info@alamia.ae">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.arabic.website">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input type="url" id="website-ar" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.arabic.website_placeholder" value="www.alamia-sharjah.ae">
                            </div>
                        </div>
                    </div>

                    <!-- Services Section -->
                    <div class="mb-6">
                        <h4 class="text-md font-semibold text-gray-900 mb-3" data-i18n="business_card.arabic.services_title">ğŸ“± Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h4>
                        <div id="services-ar-list" class="space-y-2 mb-3">
                            <!-- Services will be dynamically added here -->
                        </div>
                        <div class="flex">
                            <input type="text" id="new-service-ar" class="flex-1 px-3 py-2 border border-gray-300 rounded-s-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.arabic.new_service_placeholder">
                            <button onclick="addServiceAr()" class="px-4 py-2 bg-indigo-600 text-white rounded-e-md hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500" data-i18n="business_card.arabic.add_service">+ Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</button>
                        </div>
                    </div>
                </div>

                <!-- Design Tab Content -->
                <div id="design-content" class="tab-content hidden">
                    <div class="space-y-6">
                        <!-- Colors Section -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="business_card.design.colors_title">ğŸ¨ Colors & Design</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.design.bg_color">Background Color</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="bg-color" value="#1a1a1a" class="w-16 h-10 border border-gray-300 rounded-md">
                                        <input type="text" id="bg-color-hex" value="#1a1a1a" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="#1a1a1a">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.design.text_color">Text Color</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="text-color" value="#ffffff" class="w-16 h-10 border border-gray-300 rounded-md">
                                        <input type="text" id="text-color-hex" value="#ffffff" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="#ffffff">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Text Formatting Section -->
                        <div id="text-formatting-panel" class="hidden">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">âœï¸ Edit Selected Element</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Font Size</label>
                                    <input type="range" id="text-font-size" min="12" max="72" value="24" class="w-full">
                                    <span id="font-size-value" class="text-sm text-gray-600">24px</span>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Font Family</label>
                                    <select id="text-font-family" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="Inter">Inter (Latin)</option>
                                        <option value="Almarai">Almarai (Arabic)</option>
                                        <option value="Arial">Arial</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Verdana">Verdana</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Font Style</label>
                                    <div class="flex gap-2">
                                        <button id="text-bold" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                                            <i class="fas fa-bold"></i> Bold
                                        </button>
                                        <button id="text-italic" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                                            <i class="fas fa-italic"></i> Italic
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Text Alignment</label>
                                    <div class="flex gap-2">
                                        <button id="text-align-left" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                                            <i class="fas fa-align-left"></i> Left
                                        </button>
                                        <button id="text-align-center" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                                            <i class="fas fa-align-center"></i> Center
                                        </button>
                                        <button id="text-align-right" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                                            <i class="fas fa-align-right"></i> Right
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Text Direction</label>
                                    <div class="flex gap-2">
                                        <button id="text-direction-ltr" class="flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                                            <i class="fas fa-arrow-right"></i> LTR
                                        </button>
                                        <button id="text-direction-rtl" class="flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                                            <i class="fas fa-arrow-left"></i> RTL
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Actions</label>
                                    <div class="flex gap-2">
                                        <button id="element-copy" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                        <button id="element-delete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Logo Section -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="business_card.design.logo_title">ğŸ“ Logo & Icon</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.design.logo_label">Logo/Icon - Upload Image or Emoji</label>
                                    <input type="text" id="logo-emoji" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.design.logo_placeholder" value="ğŸ“±" maxlength="50">
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 bg-gray-100 border-2 border-gray-300 rounded-md flex items-center justify-center text-2xl overflow-hidden" id="logo-preview">ğŸ“±</div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.design.logo_help">Upload an image to replace emoji</label>
                                        <input type="file" id="logo-upload" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- QR Code Section -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="business_card.design.qr_title">ğŸ”– QR Code</h3>
                            <div class="space-y-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-20 h-20 bg-gray-100 border-2 border-gray-300 rounded-md flex items-center justify-center text-xs text-gray-500 font-medium overflow-hidden" id="qr-preview">QR</div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.design.qr_upload">QR Code - Upload Image</label>
                                        <input type="file" id="qr-upload" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <p class="text-xs text-gray-500 mt-1" data-i18n="business_card.design.qr_help">Upload your QR code image</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="business_card.design.qr_label">QR Text Label</label>
                                    <input type="text" id="qr-label" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" data-i18n-placeholder="business_card.design.qr_label_placeholder" value="SCAN ME">
                                </div>
                            </div>
                        </div>

                        <!-- Background Photo Section -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ–¼ï¸ Background Photo</h3>
                            <div class="space-y-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-20 h-12 bg-gray-100 border-2 border-gray-300 rounded-md flex items-center justify-center text-xs text-gray-500 font-medium overflow-hidden" id="bg-photo-preview">No Image</div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Background Image (Optional)</label>
                                        <input type="file" id="bg-photo-upload" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <p class="text-xs text-gray-500 mt-1">Upload a background image for your card</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div class="pt-6 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button onclick="exportBusinessCard('english')" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 font-medium">
                                    <i class="fas fa-download mr-2"></i>
                                    <span data-i18n="business_card.design.export_english">Export English</span>
                                </button>
                                <button onclick="exportBusinessCard('arabic')" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 font-medium">
                                    <i class="fas fa-download mr-2"></i>
                                    <span data-i18n="business_card.design.export_arabic">Export Arabic</span>
                                </button>
                                <button onclick="exportBusinessCard('both')" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 font-medium">
                                    <i class="fas fa-download mr-2"></i>
                                    <span>Export Both</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="bg-white rounded-xl shadow-lg p-6 lg:col-span-2">
                <div class="text-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="business_card.preview.title">Card Preview</h3>
                    <p class="text-sm text-gray-600" data-i18n="business_card.preview.description">Your business cards will appear below</p>
                </div>
                
                <!-- Canvas Container -->
                <div class="bg-gray-50 rounded-lg p-6 min-h-[400px] flex items-center justify-center">
                    <div id="business-card-canvas" class="bg-white rounded-lg shadow-lg border border-gray-200">
                        <!-- Konva canvas will be inserted here -->
                    </div>
                </div>
                
                <!-- Preview Controls -->
                <div class="mt-6 text-center">
                    <div class="flex justify-center gap-8">
                        <button onclick="previewBusinessCard('english')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <span data-i18n="business_card.tabs.english">English Side</span>
                        </button>
                        <button onclick="previewBusinessCard('arabic')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <span data-i18n="business_card.tabs.arabic">Arabic Side</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>`;
    }
    /**
     * Enhanced Discount Offer Tool Content
     */
    async getDiscountOfferToolContent() {
        // Load the new template
        try {
            const response = await fetch('templates/discount_offer_new.html');
            if (!response.ok) throw new Error('Failed to load template');
            return await response.text();
        } catch (error) {
            console.error('Error loading discount offer template:', error);
            return '<div>Error loading discount offer tool</div>';
        }
    }

<style>
    .discount-tool {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        font-family: 'Cairo', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: white;
    }

    .discount-tool .main-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .discount-tool .tool-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 20px;
    }

    .discount-tool .tool-header h1 {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #fff, #f0f0f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .discount-tool .tool-header p {
        font-size: 14px;
        opacity: 0.9;
        margin: 0;
    }

    .discount-tool .format-selector {
        margin-bottom: 25px;
    }

    .discount-tool .format-selector h3 {
        font-size: 16px;
        margin-bottom: 15px;
        color: #fff;
        font-weight: 600;
    }

    .discount-tool .format-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .discount-tool .format-btn {
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 15px;
        color: white;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        backdrop-filter: blur(5px);
    }

    .discount-tool .format-btn:hover,
    .discount-tool .format-btn.active {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .discount-tool .content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 25px;
    }

    .discount-tool .editor-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-height: 80vh;
        overflow-y: auto;
    }

    .discount-tool .panel-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .discount-tool .control-group {
        margin-bottom: 20px;
    }

    .discount-tool .control-group h4 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #fff;
        opacity: 0.9;
    }

    .discount-tool .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }

    .discount-tool .form-group {
        margin-bottom: 15px;
    }

    .discount-tool .form-group label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #fff;
        opacity: 0.8;
    }

    .discount-tool .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        backdrop-filter: blur(5px);
    }

    .discount-tool .form-control::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .discount-tool .form-control:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .discount-tool .btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s;
        font-family: 'Cairo', sans-serif;
    }

    .discount-tool .btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
    }

    .discount-tool .btn-success {
        background: linear-gradient(45deg, #28a745, #20c997);
    }

    .discount-tool .btn-danger {
        background: linear-gradient(45deg, #dc3545, #fd7e14);
    }

    .discount-tool .btn-warning {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
        color: #000;
    }

    .discount-tool .buttons-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 15px;
    }

    .discount-tool .viewer-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
    }

    .discount-tool #discount-canvas {
        margin: 20px auto;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        backdrop-filter: blur(5px);
    }

    .discount-tool .export-section {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
    }

    .discount-tool .selection-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 12px;
        border-left: 4px solid rgba(255, 255, 255, 0.5);
        display: none;
    }

    .discount-tool .edit-controls {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: none;
    }

    .discount-tool .edit-controls h4 {
        font-size: 14px;
        margin-bottom: 10px;
        font-weight: 700;
        color: #fff;
    }

    .discount-tool .text-formatting-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 10px;
    }

    .discount-tool .background-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }

    .discount-tool .color-preset {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .discount-tool .color-preset:hover {
        transform: scale(1.1);
        border-color: rgba(255, 255, 255, 0.6);
    }

    @media (max-width: 768px) {
        .discount-tool .content {
            grid-template-columns: 1fr;
        }
        
        .discount-tool .format-buttons {
            grid-template-columns: 1fr;
        }
        
        .discount-tool .export-section {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="discount-tool">
    <div class="main-container">
        <!-- Tool Header -->
        <div class="tool-header">
            <h1><i class="fas fa-percent"></i> Ø£Ø¯Ø§Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø®ØµÙ…</h1>
            <p>ØµÙ…Ù… Ø¹Ø±ÙˆØ¶ Ø®ØµÙ… Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¨ØªÙ‚Ù†ÙŠØ© Konva.js Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</p>
        </div>

        <!-- Format Selection -->
        <div class="format-selector">
            <h3><i class="fas fa-crop-alt"></i> Ø§Ø®ØªØ± ØµÙŠØºØ© Ø§Ù„ØªØµÙ…ÙŠÙ…</h3>
            <div class="format-buttons">
                <button class="format-btn active" onclick="selectDiscountFormat('square')">
                    <i class="fas fa-square"></i><br>Ù…Ø±Ø¨Ø¹<br>1080Ã—1080 px
                </button>
                <button class="format-btn" onclick="selectDiscountFormat('horizontal')">
                    <i class="fas fa-rectangle-landscape"></i><br>Ø£ÙÙ‚ÙŠ<br>1200Ã—630 px
                </button>
                <button class="format-btn" onclick="selectDiscountFormat('vertical')">
                    <i class="fas fa-rectangle-portrait"></i><br>Ø³ØªÙˆØ±ÙŠ<br>1080Ã—1920 px
                </button>
                <button class="format-btn" onclick="selectDiscountFormat('wide')">
                    <i class="fas fa-panorama"></i><br>Ø¨Ø§Ù†Ø± Ø¹Ø±ÙŠØ¶<br>1500Ã—500 px
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Editor Panel -->
            <div class="editor-panel">
                <h2 class="panel-title">
                    <i class="fas fa-edit"></i>
                    Ù…Ø­Ø±Ø± Ø§Ù„ØªØµÙ…ÙŠÙ…
                </h2>

                <!-- Discount Information -->
                <div class="control-group">
                    <h4><i class="fas fa-percentage"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®ØµÙ…</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…</label>
                            <input type="text" class="form-control" value="50%" placeholder="50%">
                        </div>
                        <div class="form-group">
                            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶</label>
                            <input type="text" class="form-control" value="Ø®ØµÙ… ÙƒØ¨ÙŠØ±" placeholder="Ø®ØµÙ… ÙƒØ¨ÙŠØ±">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶</label>
                        <input type="text" class="form-control" value="Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©" placeholder="Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ÙØªØ±Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶</label>
                            <input type="text" class="form-control" value="Ø§Ù„Ø¹Ø±Ø¶ Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰ Ù£Ù¡ Ø¯ÙŠØ³Ù…Ø¨Ø±" placeholder="Ø§Ù„Ø¹Ø±Ø¶ Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰...">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±/Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</label>
                            <input type="text" class="form-control" value="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±" placeholder="Ø§Ø³Ù… Ù…ØªØ¬Ø±Ùƒ">
                        </div>
                    </div>
                </div>

                <!-- Selection Info -->
                <div class="discount-selection-info selection-info">
                    Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø¹Ù†ØµØ±
                </div>

                <!-- Text Edit Controls -->
                <div class="discount-edit-controls edit-controls">
                    <h4><i class="fas fa-font"></i> ØªØ­Ø±ÙŠØ± Ø§Ù„Ù†Øµ</h4>
                    
                    <div class="form-group">
                        <label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Øµ</label>
                        <input type="text" id="discount-text-content" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ">
                        <button type="button" class="btn btn-success" onclick="updateDiscountText()" style="margin-top: 5px; width: 100%;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ</button>
                    </div>

                    <div class="text-formatting-buttons">
                        <button class="btn" onclick="makeDiscountTextBold()"><i class="fas fa-bold"></i> Ø¹Ø±ÙŠØ¶</button>
                        <button class="btn" onclick="makeDiscountTextItalic()"><i class="fas fa-italic"></i> Ù…Ø§Ø¦Ù„</button>
                        <button class="btn" onclick="alignDiscountTextCenter()"><i class="fas fa-align-center"></i> ÙˆØ³Ø·</button>
                        <button class="btn" onclick="alignDiscountTextLeft()"><i class="fas fa-align-left"></i> ÙŠØ³Ø§Ø±</button>
                        <button class="btn" onclick="alignDiscountTextRight()"><i class="fas fa-align-right"></i> ÙŠÙ…ÙŠÙ†</button>
                        <button class="btn btn-danger" onclick="deleteDiscountElement()"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
                            <input type="number" id="discount-font-size" class="form-control" value="24" min="10" max="200" onchange="updateDiscountFontSize()">
                        </div>
                        <div class="form-group">
                            <label>Ù„ÙˆÙ† Ø§Ù„Ù†Øµ</label>
                            <input type="color" id="discount-text-color" class="form-control" value="#ffffff" onchange="updateDiscountTextColor()">
                        </div>
                    </div>
                </div>

                <!-- Background Controls -->
                <div class="control-group">
                    <h4><i class="fas fa-palette"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©</h4>
                    
                    <div class="background-controls">
                        <div class="color-preset" style="background: #ff4757;" onclick="changeDiscountBackground('#ff4757')"></div>
                        <div class="color-preset" style="background: #5352ed;" onclick="changeDiscountBackground('#5352ed')"></div>
                        <div class="color-preset" style="background: #00d2d3;" onclick="changeDiscountBackground('#00d2d3')"></div>
                        <div class="color-preset" style="background: #ff6b35;" onclick="changeDiscountBackground('#ff6b35')"></div>
                        <div class="color-preset" style="background: #6c5ce7;" onclick="changeDiscountBackground('#6c5ce7')"></div>
                        <div class="color-preset" style="background: #a29bfe;" onclick="changeDiscountBackground('#a29bfe')"></div>
                        <div class="color-preset" style="background: #fd79a8;" onclick="changeDiscountBackground('#fd79a8')"></div>
                        <div class="color-preset" style="background: #00b894;" onclick="changeDiscountBackground('#00b894')"></div>
                        <div class="color-preset" style="background: #e17055;" onclick="changeDiscountBackground('#e17055')"></div>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ©</label>
                        <input type="file" class="form-control" accept="image/*" onchange="uploadDiscountBackground(event)">
                    </div>
                </div>

                <!-- Add Elements -->
                <div class="control-group">
                    <h4><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ±</h4>
                    <div class="buttons-grid">
                        <button class="btn btn-success" onclick="addDiscountText()">
                            <i class="fas fa-font"></i> Ø¥Ø¶Ø§ÙØ© Ù†Øµ
                        </button>
                        <button class="btn btn-warning" onclick="addDiscountText('NEW!')">
                            <i class="fas fa-star"></i> Ù†Øµ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>

                <!-- Export Section -->
                <div class="export-section">
                    <button class="btn btn-success" onclick="exportDiscountOffer('png', 1)">
                        <i class="fas fa-download"></i> PNG Ø¹Ø§Ø¯ÙŠ
                    </button>
                    <button class="btn btn-success" onclick="exportDiscountOffer('png', 2)">
                        <i class="fas fa-download"></i> PNG Ø¹Ø§Ù„ÙŠ
                    </button>
                    <button class="btn btn-success" onclick="exportDiscountOffer('jpg', 1)">
                        <i class="fas fa-download"></i> JPG
                    </button>
                </div>
            </div>

            <!-- Viewer Panel -->
            <div class="viewer-panel">
                <h2 class="panel-title">
                    <i class="fas fa-eye"></i>
                    Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØµÙ…ÙŠÙ…
                </h2>

                <div id="discount-canvas"></div>
                
                <p style="font-size: 12px; opacity: 0.8; margin-top: 15px;">
                    <i class="fas fa-info-circle"></i>
                    Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù†ØµØ± Ù„ØªØ­Ø¯ÙŠØ¯Ù‡ ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡
                </p>
            </div>
        </div>
    </div>
</div>`;
    }

    /**
     * Load tool scripts sequentially to ensure dependencies
     */
    async loadToolScriptsSequentially(scripts, toolName) {
        const externalScripts = [];
        const inlineScripts = [];
        
        // Separate external and inline scripts
        scripts.forEach((script, index) => {
            console.log(`Script ${index + 1}:`, script.src || 'inline', script.src ? 'external' : 'inline');
            if (script.src) {
                externalScripts.push(script);
            } else {
                inlineScripts.push(script);
            }
        });
        
        console.log(`Found ${externalScripts.length} external scripts and ${inlineScripts.length} inline scripts`);
        
        // Load external scripts first, in order
        for (const script of externalScripts) {
            if (!document.querySelector(`script[src="${script.src}"]`)) {
                console.log(`Loading external script: ${script.src}`);
                await this.loadExternalScript(script.src);
            }
        }
        
        // Then execute inline scripts
        inlineScripts.forEach((script, index) => {
            try {
                console.log(`Executing inline script ${index + 1} for ${toolName}`);
                const scriptEl = document.createElement('script');
                scriptEl.setAttribute('data-tool', toolName);
                scriptEl.setAttribute('data-script-index', index);
                scriptEl.textContent = script.textContent;
                document.head.appendChild(scriptEl);
            } catch (error) {
                console.error(`Error executing inline script ${index + 1}:`, error);
            }
        });
    }

    /**
     * Load tool content dynamically
     */
    async loadTool(toolName) {
        console.log(`Starting to load tool: ${toolName}`);
        
        // Get inline tool content
        const html = this.getInlineToolContent(toolName);
        if (!html) {
            console.error(`Tool ${toolName} not found in inline content`);
            throw new Error('Tool not found');
        }
        
        console.log(`Using inline content for ${toolName}, length: ${html.length}`);
        
        try {
            
            // Since templates are now self-contained fragments, just insert directly
            console.log(`Template content length: ${html.length}`);
            
            // Insert content
            const contentContainer = document.getElementById(`${toolName}-content`);
            if (!contentContainer) {
                console.error(`Content container not found: ${toolName}-content`);
                throw new Error('Content container not found');
            }
            
            contentContainer.innerHTML = html;
            console.log(`Template inserted into container`);
            
            // Parse and execute template scripts
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const scripts = tempDiv.querySelectorAll('script');
            
            console.log(`Found ${scripts.length} script tags in template`);
            
            // Load external scripts first, then inline scripts
            await this.loadToolScriptsSequentially(scripts, toolName);
            
            console.log('All scripts loaded successfully');
            
            // Auto-initialize tools after loading
            if (toolName === 'social-media') {
                console.log('ğŸ¯ Social media tool loaded. Auto-initializing...');
                setTimeout(() => {
                    if (window.initializeSocialMediaToolManually) {
                        console.log('ğŸš€ Auto-triggering social media tool initialization');
                        window.initializeSocialMediaToolManually();
                    }
                }, 100);
            } else if (toolName === 'business-card') {
                console.log('ğŸ¯ Business card tool loaded. Auto-initializing...');
                setTimeout(() => {
                    if (window.initBusinessCardToolIfNeeded) {
                        console.log('ğŸš€ Auto-triggering business card tool initialization');
                        window.initBusinessCardToolIfNeeded();
                    }
                }, 500);
            } else if (toolName === 'discount-offer') {
                console.log('ğŸ¯ Discount offer tool loaded. Auto-initializing...');
                setTimeout(() => {
                    if (typeof initializeDiscountTool === 'function') {
                        console.log('ğŸš€ Auto-triggering discount offer tool initialization');
                        initializeDiscountTool();
                    }
                }, 500);
            }
            
            // Apply i18n translations after content is loaded
            if (window.i18n) {
                console.log('Applying i18n translations to tool content');
                window.i18n.updatePageText();
            }
            
            // Create tool namespace to avoid conflicts
            this.createToolNamespace(toolName);
            
            this.toolsLoaded.add(toolName);
            console.log(`Tool ${toolName} loaded successfully`);
            
        } catch (error) {
            console.error(`Error loading tool ${toolName}:`, error);
            throw error;
        }
    }

    /**
     * Load tool-specific styles
     */
    async loadToolStyles(doc, toolName) {
        const styles = doc.querySelectorAll('style');
        
        styles.forEach((style, index) => {
            const styleId = `style-${toolName}-${index}`;
            
            if (!document.getElementById(styleId)) {
                const newStyle = document.createElement('style');
                newStyle.id = styleId;
                newStyle.setAttribute('data-tool', toolName);
                
                // Scope styles to tool content to prevent conflicts
                let scopedCSS = style.textContent;
                
                // Basic CSS scoping - prefix selectors with tool container
                scopedCSS = this.scopeCSS(scopedCSS, `#${toolName}-content`);
                
                newStyle.textContent = scopedCSS;
                document.head.appendChild(newStyle);
            }
        });
    }

    /**
     * Load tool-specific scripts
     */
    async loadToolScripts(doc, toolName) {
        // Load external scripts first
        const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
        
        for (const script of externalScripts) {
            if (!document.querySelector(`script[src="${script.src}"]`)) {
                await this.loadExternalScript(script.src);
            }
        }
        
        // Then load inline scripts
        const inlineScripts = doc.querySelectorAll('script:not([src])');
        
        inlineScripts.forEach((script, index) => {
            try {
                // Create tool-scoped execution context
                const toolScript = document.createElement('script');
                toolScript.setAttribute('data-tool', toolName);
                toolScript.setAttribute('data-script-index', index);
                
                // Wrap script in namespace
                const wrappedScript = `
                    (function() {
                        // Tool namespace
                        const TOOL_NAME = '${toolName}';
                        const TOOL_CONTAINER = document.getElementById('${toolName}-content');
                        
                        // Helper to scope element queries to this tool
                        const $ = (selector) => TOOL_CONTAINER.querySelector(selector);
                        const $$ = (selector) => TOOL_CONTAINER.querySelectorAll(selector);
                        
                        // Prevent global variable conflicts by creating local scope
                        ${script.textContent}
                    })();
                `;
                
                toolScript.textContent = wrappedScript;
                document.body.appendChild(toolScript);
                
            } catch (error) {
                console.warn(`Error executing script for ${toolName}:`, error);
            }
        });
    }

    /**
     * Load external script
     */
    loadExternalScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    /**
     * Create tool namespace to prevent conflicts
     */
    createToolNamespace(toolName) {
        // Create tool-specific namespace
        if (!window.MarketingTools) {
            window.MarketingTools = {};
        }
        
        if (!window.MarketingTools[toolName]) {
            window.MarketingTools[toolName] = {
                container: document.getElementById(`${toolName}-content`),
                name: toolName,
                $: (selector) => document.getElementById(`${toolName}-content`).querySelector(selector),
                $$: (selector) => document.getElementById(`${toolName}-content`).querySelectorAll(selector)
            };
        }
    }

    /**
     * Basic CSS scoping
     */
    scopeCSS(css, scope) {
        // Simple scoping - this could be enhanced with a proper CSS parser
        const lines = css.split('\n');
        let scopedCSS = '';
        let inMediaQuery = false;
        
        for (let line of lines) {
            const trimmed = line.trim();
            
            // Skip empty lines and comments
            if (!trimmed || trimmed.startsWith('/*') || trimmed.endsWith('*/')) {
                scopedCSS += line + '\n';
                continue;
            }
            
            // Handle media queries
            if (trimmed.startsWith('@media')) {
                inMediaQuery = true;
                scopedCSS += line + '\n';
                continue;
            }
            
            if (inMediaQuery && trimmed === '}') {
                inMediaQuery = false;
                scopedCSS += line + '\n';
                continue;
            }
            
            // Don't scope keyframes, media queries, or root-level rules
            if (trimmed.startsWith('@') || trimmed.startsWith(':root') || inMediaQuery) {
                scopedCSS += line + '\n';
                continue;
            }
            
            // Scope regular CSS rules
            if (trimmed.includes('{') && !trimmed.includes('@')) {
                const [selector, ...rest] = trimmed.split('{');
                const rules = rest.join('{');
                
                // Don't scope body, html, or universal selectors
                if (!selector.trim().match(/^(body|html|\*)(\s|$|,)/)) {
                    scopedCSS += `${scope} ${selector.trim()} {${rules}\n`;
                } else {
                    scopedCSS += line + '\n';
                }
            } else {
                scopedCSS += line + '\n';
            }
        }
        
        return scopedCSS;
    }

    /**
     * Update navigation active states
     */
    updateNavigation(activeTool) {
        // Update desktop navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.tool === activeTool) {
                link.classList.add('active');
            }
        });
        
        // Update mobile navigation
        document.querySelectorAll('.mobile-nav-link').forEach(link => {
            link.classList.remove('bg-primary-50', 'text-primary-600');
            if (link.dataset.tool === activeTool) {
                link.classList.add('bg-primary-50', 'text-primary-600');
            }
        });
    }

    /**
     * Show loading overlay
     */
    showLoading() {
        console.log('ğŸ“ SHOWING loading overlay');
        this.isLoading = true;
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex'; // Force display
            console.log('ğŸ“ Loading overlay VISIBLE');
            
            // Force hide after 3 seconds as safety backup (reduced time)
            setTimeout(() => {
                if (this.isLoading) {
                    console.log('ğŸš¨ FORCE hiding loading overlay after timeout');
                    this.hideLoading();
                }
            }, 3000);
        }
    }

    /**
     * Hide loading overlay
     */
    hideLoading() {
        console.log('ğŸ“ HIDING loading overlay');
        this.isLoading = false;
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.classList.add('hidden');
            overlay.style.display = 'none'; // Force hide
            console.log('ğŸ“ Loading overlay HIDDEN');
        }
    }

    /**
     * Show notification using SweetAlert2
     */
    showNotification(message, type = 'success') {
        // Use SweetAlert2 for unified notifications
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: type === 'error' ? 'error' : 'success',
                title: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: {
                    popup: 'colored-toast'
                }
            });
        } else {
            // Fallback to console if SweetAlert2 is not available
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    }

    /**
     * Get tool instance
     */
    getToolInstance(toolName) {
        return this.toolInstances.get(toolName);
    }

    /**
     * Clean up scripts from other tools to prevent conflicts
     */
    cleanupOldToolScripts(currentTool) {
        // Don't clean up scripts from the tool we're about to load
        const allTools = ['business-card', 'discount-offer', 'social-media'];
        const otherTools = allTools.filter(tool => tool !== currentTool);
        
        otherTools.forEach(toolName => {
            // Only remove scripts from tools that might conflict
            document.querySelectorAll(`script[data-tool="${toolName}"]`).forEach(script => {
                console.log(`Removing conflicting script from ${toolName}`);
                script.remove();
            });
        });
    }

    /**
     * Clean up tool resources
     */
    cleanupTool(toolName) {
        // Remove tool-specific styles
        document.querySelectorAll(`style[data-tool="${toolName}"]`).forEach(style => {
            style.remove();
        });
        
        // Remove tool-specific scripts
        document.querySelectorAll(`script[data-tool="${toolName}"]`).forEach(script => {
            script.remove();
        });
        
        // Clear tool content
        const container = document.getElementById(`${toolName}-content`);
        if (container) {
            container.innerHTML = '';
        }
        
        // Remove from loaded tools
        this.toolsLoaded.delete(toolName);
        
        // Remove tool instance
        this.toolInstances.delete(toolName);
        
        // Clean up namespace
        if (window.MarketingTools?.[toolName]) {
            delete window.MarketingTools[toolName];
        }
    }
}

// Global functions for backward compatibility
let app;

window.showHome = (updateHistory = true) => {
    app?.showHome(updateHistory);
};

window.showTool = (toolName, updateHistory = true) => {
    app?.showTool(toolName, updateHistory);
};

window.showNotification = (message, type = 'success') => {
    app?.showNotification(message, type);
};

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    app = new MarketingToolsApp();
    
    // Expose app instance globally for debugging
    window.app = app;
    window.MarketingToolsApp = app;
    
    console.log('âœ… App initialized and available as window.app');
});

// Handle page reload/refresh
window.addEventListener('load', () => {
    // Check hash first, then path
    const hash = window.location.hash;
    const path = window.location.pathname;
    
    if (hash) {
        // Hash-based routing (e.g., #/business-card)
        const toolName = hash.replace('#/', '');
        if (['business-card', 'discount-offer', 'social-media'].includes(toolName)) {
            app?.showTool(toolName, false);
            return;
        }
    }
    
    if (path === '/' || path === '/index.html') {
        app?.showHome(false);
    } else {
        const toolName = path.replace('/', '');
        if (['business-card', 'discount-offer', 'social-media'].includes(toolName)) {
            app?.showTool(toolName, false);
        } else {
            app?.showHome(false);
        }
    }
});

// Handle hash changes
window.addEventListener('hashchange', () => {
    const hash = window.location.hash;
    if (hash) {
        const toolName = hash.replace('#/', '');
        if (['business-card', 'discount-offer', 'social-media'].includes(toolName)) {
            app?.showTool(toolName, false);
        } else {
            app?.showHome(false);
        }
    } else {
        app?.showHome(false);
    }
});

// Export for module systems
if (typeof module !== 'undefined' && module.exports) {
    module.exports = MarketingToolsApp;
}